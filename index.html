<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å¤§å­—æŠ¥">
  <meta name="theme-color" content="#1a1a1a">
  <title>å¤§å­—æŠ¥ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <link rel="manifest" href="./manifest.json">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #1a1a1a;
      color: #fff;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
      letter-spacing: 0.05em;
    }

    .section {
      background: #252525;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #999;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* æ—¥ä»˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .date-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .date-btn {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      background: #3a3a3a;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .date-btn:active {
      background: #4a4a4a;
      transform: scale(0.98);
    }

    .date-selects {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .select-wrapper {
      flex: 1;
      position: relative;
    }

    .select-wrapper::after {
      content: 'â–¼';
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #999;
      font-size: 12px;
    }

    select {
      width: 100%;
      padding: 18px 12px;
      font-size: 18px;
      font-weight: 600;
      border: 2px solid #3a3a3a;
      border-radius: 10px;
      background: #2a2a2a;
      color: #fff;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    select:focus {
      outline: none;
      border-color: #4a90e2;
    }

    .date-display {
      padding: 12px;
      background: #2a2a2a;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #4a90e2;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .date-display.empty {
      color: #666;
      font-size: 16px;
      font-weight: 400;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
    textarea {
      width: 100%;
      min-height: 200px;
      padding: 18px;
      font-size: 18px;
      line-height: 1.6;
      border: 2px solid #3a3a3a;
      border-radius: 12px;
      background: #2a2a2a;
      color: #fff;
      resize: vertical;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: #4a90e2;
    }

    textarea::placeholder {
      color: #666;
    }

    /* ãƒœã‚¿ãƒ³ */
    .action-btn {
      width: 100%;
      padding: 20px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.05em;
    }

    .btn-generate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      margin-bottom: 12px;
    }

    .btn-generate:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .btn-save {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
    }

    .btn-save:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .btn-save:disabled {
      background: #3a3a3a;
      color: #666;
      cursor: not-allowed;
    }

    /* Canvas */
    #canvas {
      display: block;
      width: 100%;
      border-radius: 12px;
      background: #fff;
      margin-top: 12px;
    }

    .canvas-container {
      display: none;
    }

    .canvas-container.show {
      display: block;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 13px;
    }

    .install-prompt {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 14px;
      color: #999;
      display: none;
    }

    .install-prompt.show {
      display: block;
    }

    .install-prompt strong {
      color: #4a90e2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“‹ å¤§å­—æŠ¥ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†… -->
    <div class="install-prompt" id="installPrompt">
      <strong>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </strong>ã—ã¦<br>ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãˆã¾ã™
    </div>

    <!-- â‘  æ—¥ä»˜å…¥åŠ› -->
    <div class="section">
      <div class="section-title">â‘  æ—¥ä»˜</div>
      
      <div class="date-controls">
        <button class="date-btn" id="todayBtn">ä»Šæ—¥</button>
        <button class="date-btn" id="clearDateBtn">æ—¥ä»˜ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="date-selects">
        <div class="select-wrapper">
          <select id="yearSelect" aria-label="å¹´">
            <option value="">å¹´</option>
          </select>
        </div>
        <div class="select-wrapper">
          <select id="monthSelect" aria-label="æœˆ">
            <option value="">æœˆ</option>
          </select>
        </div>
        <div class="select-wrapper">
          <select id="daySelect" aria-label="æ—¥">
            <option value="">æ—¥</option>
          </select>
        </div>
      </div>

      <div class="date-display empty" id="dateDisplay">æ—¥ä»˜æœªæŒ‡å®š</div>
    </div>

    <!-- â‘¡ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
    <div class="section">
      <div class="section-title">â‘¡ ãƒ†ã‚­ã‚¹ãƒˆ</div>
      <textarea 
        id="textInput" 
        placeholder="ä»Šæ—¥ã‚„ã‚‹ã“ã¨&#10;ãƒ»å…¥åº«å‡¦ç†&#10;ãƒ»æ’®å½±&#10;ãƒ»ç™ºé€"
        aria-label="æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ"
      ></textarea>
    </div>

    <!-- â‘¢ ç”Ÿæˆãƒœã‚¿ãƒ³ -->
    <button class="action-btn btn-generate" id="generateBtn">
      â‘¢ ç”Ÿæˆ
    </button>

    <!-- Canvasè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="canvas-container" id="canvasContainer">
      <canvas id="canvas" width="800" height="800"></canvas>
    </div>

    <!-- â‘£ ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <button class="action-btn btn-save" id="saveBtn" disabled>
      â‘£ ç”»åƒã‚’é–‹ã
    </button>

    <div class="footer">
      iPhone Safari ã§ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã™ã‚‹ã¨<br>
      ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãˆã¾ã™
    </div>
  </div>

  <script>
    // PWAç™»éŒ²
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed', err));
    }

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…è¡¨ç¤º
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                      || window.navigator.standalone 
                      || document.referrer.includes('android-app://');
    
    if (!isStandalone) {
      document.getElementById('installPrompt').classList.add('show');
    }

    // è¦ç´ å–å¾—
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const daySelect = document.getElementById('daySelect');
    const dateDisplay = document.getElementById('dateDisplay');
    const todayBtn = document.getElementById('todayBtn');
    const clearDateBtn = document.getElementById('clearDateBtn');
    const textInput = document.getElementById('textInput');
    const generateBtn = document.getElementById('generateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const canvas = document.getElementById('canvas');
    const canvasContainer = document.getElementById('canvasContainer');
    const ctx = canvas.getContext('2d');

    // å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆ2020-2030ï¼‰
    const currentYear = new Date().getFullYear();
    for (let year = currentYear - 5; year <= currentYear + 5; year++) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year + 'å¹´';
      yearSelect.appendChild(option);
    }

    // æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
    for (let month = 1; month <= 12; month++) {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = month + 'æœˆ';
      monthSelect.appendChild(option);
    }

    // æ—¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
    function updateDayOptions() {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      
      daySelect.innerHTML = '<option value="">æ—¥</option>';
      
      if (!year || !month) {
        for (let day = 1; day <= 31; day++) {
          const option = document.createElement('option');
          option.value = day;
          option.textContent = day + 'æ—¥';
          daySelect.appendChild(option);
        }
        return;
      }

      const daysInMonth = new Date(year, month, 0).getDate();
      for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + 'æ—¥';
        daySelect.appendChild(option);
      }
    }

    updateDayOptions();

    // æ—¥ä»˜è¡¨ç¤ºæ›´æ–°
    function updateDateDisplay() {
      const year = yearSelect.value;
      const month = monthSelect.value;
      const day = daySelect.value;

      if (year && month && day) {
        dateDisplay.textContent = `${year}.${String(month).padStart(2, '0')}.${String(day).padStart(2, '0')}`;
        dateDisplay.classList.remove('empty');
      } else {
        dateDisplay.textContent = 'æ—¥ä»˜æœªæŒ‡å®š';
        dateDisplay.classList.add('empty');
      }
    }

    // ä»Šæ—¥ãƒœã‚¿ãƒ³
    todayBtn.addEventListener('click', () => {
      const today = new Date();
      yearSelect.value = today.getFullYear();
      monthSelect.value = today.getMonth() + 1;
      updateDayOptions();
      daySelect.value = today.getDate();
      updateDateDisplay();
    });

    // æ—¥ä»˜ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearDateBtn.addEventListener('click', () => {
      yearSelect.value = '';
      monthSelect.value = '';
      daySelect.value = '';
      updateDateDisplay();
    });

    // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚
    yearSelect.addEventListener('change', () => {
      updateDayOptions();
      updateDateDisplay();
    });
    monthSelect.addEventListener('change', () => {
      updateDayOptions();
      updateDateDisplay();
    });
    daySelect.addEventListener('change', updateDateDisplay);

    // Canvasæç”»é–¢æ•°
    function drawDazibao() {
      const text = textInput.value.trim();
      if (!text) {
        alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // Canvas ã‚¯ãƒªã‚¢
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, 800, 800);

      // å¤–æ 
      ctx.strokeStyle = '#dddddd';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.roundRect(20, 20, 760, 760, 20);
      ctx.stroke();

      let currentY = 80;

      // æ—¥ä»˜è¡¨ç¤ºï¼ˆæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      const year = yearSelect.value;
      const month = monthSelect.value;
      const day = daySelect.value;

      if (year && month && day) {
        const dateStr = `${year}.${String(month).padStart(2, '0')}.${String(day).padStart(2, '0')}`;
        ctx.fillStyle = '#666666';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(dateStr, 400, currentY);
        currentY += 80;
      } else {
        currentY += 20;
      }

      // ãƒ†ã‚­ã‚¹ãƒˆæç”»ï¼ˆè‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰
      const lines = text.split('\n');
      const maxWidth = 720;
      const lineHeight = 1.5;

      // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—
      let fontSize = 72;
      const minFontSize = 26;

      ctx.textAlign = 'left';
      ctx.fillStyle = '#000000';

      // é©åˆ‡ãªãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æ¢ã™
      while (fontSize >= minFontSize) {
        ctx.font = `bold ${fontSize}px sans-serif`;
        
        let totalHeight = currentY;
        let allFit = true;

        for (const line of lines) {
          if (!line.trim()) {
            totalHeight += fontSize * lineHeight * 0.5;
            continue;
          }

          const words = line.split('');
          let currentLine = '';
          let lineCount = 0;

          for (const word of words) {
            const testLine = currentLine + word;
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && currentLine) {
              lineCount++;
              currentLine = word;
            } else {
              currentLine = testLine;
            }
          }
          if (currentLine) lineCount++;

          totalHeight += fontSize * lineHeight * lineCount;
        }

        if (totalHeight <= 750) {
          break;
        }

        fontSize -= 2;
      }

      // å®Ÿéš›ã«æç”»
      ctx.font = `bold ${fontSize}px sans-serif`;
      let y = currentY;

      for (const line of lines) {
        if (!line.trim()) {
          y += fontSize * lineHeight * 0.5;
          continue;
        }

        const words = line.split('');
        let currentLine = '';
        let x = 60;

        for (const word of words) {
          const testLine = currentLine + word;
          const metrics = ctx.measureText(testLine);
          
          if (metrics.width > maxWidth && currentLine) {
            ctx.fillText(currentLine, x, y);
            y += fontSize * lineHeight;
            currentLine = word;
          } else {
            currentLine = testLine;
          }
        }

        if (currentLine) {
          ctx.fillText(currentLine, x, y);
          y += fontSize * lineHeight;
        }
      }

      // Canvasè¡¨ç¤º
      canvasContainer.classList.add('show');
      saveBtn.disabled = false;

      // Canvasã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      setTimeout(() => {
        canvasContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    // â‘¢ ç”Ÿæˆãƒœã‚¿ãƒ³
    generateBtn.addEventListener('click', drawDazibao);

    // â‘£ ç”»åƒã‚’é–‹ããƒœã‚¿ãƒ³
    saveBtn.addEventListener('click', () => {
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      });
    });

    // CanvasRenderingContext2D.roundRect ã®ãƒãƒªãƒ•ã‚£ãƒ«ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
        this.moveTo(x + radius, y);
        this.lineTo(x + width - radius, y);
        this.quadraticCurveTo(x + width, y, x + width, y + radius);
        this.lineTo(x + width, y + height - radius);
        this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        this.lineTo(x + radius, y + height);
        this.quadraticCurveTo(x, y + height, x, y + height - radius);
        this.lineTo(x, y + radius);
        this.quadraticCurveTo(x, y, x + radius, y);
      };
    }
  </script>
</body>
</html>
